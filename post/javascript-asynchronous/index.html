<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
<title>
    Lesenelir&#39;s Blog
</title>
<!--[if lt IE 9]><script src="//cdn.bootcss.com/html5shiv/r29/html5.js"></script><![endif]-->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
<meta http-equiv="x-dns-prefetch-control" content="on">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<meta name="author" content="Lesenelir">
<meta name="description" content="You media must remember, do not &#34;see the wind, is to get rain&#34;.">
<meta name="keywords" content="">
<script async src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
<link rel="stylesheet" href="https://lesenelir.github.io/styles/main.css" />
<link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="https://apps.bdimg.com/libs/jquery/1.7.1/jquery.min.js"></script>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/css/style.min.css" />
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/tocbot.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/script.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/itjoker233/Gridea-theme-Chic/assets/media/script/icon.min.js"></script>
        
            <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/Card/prism.min.js"></script>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/css/Card/prism.min.css" />
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.css">
            <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.min.js"></script>
            
                <!--点击特效-->
                <script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/love.min.js"></script>
                
                            <script>
                                (function() {
                                    var bp = document.createElement('script');
                                    var curProtocol = window.location.protocol.split(':')[0];
                                    if (curProtocol === 'https') {
                                        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
                                    } else {
                                        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                                    }
                                    var s = document.getElementsByTagName("script")[0];
                                    s.parentNode.insertBefore(bp, s);
                                })();
                            </script>
                            
</head>

<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo">
                <a href="https://lesenelir.github.io">
                    Lesenelir&#39;s Blog
                </a>
            </div>
            <div id="tp-weather-widget"></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/">
                        Home
                    </a>
                    
                    <a class="menu-item" href="/post/about">
                        About
                    </a>
                    
                    <a class="menu-item" href="/archives">
                        Archives
                    </a>
                    
                    <a class="menu-item" href="/tags">
                        Tags
                    </a>
                    
                    <a class="menu-item" href="/post/timeline">
                        Timeline
                    </a>
                    
                    <a class="menu-item" href="https://github.com/lesenelir">
                        Github
                    </a>
                    
                        <input id="switch_default" type="checkbox" class="switch_default">
                        <label for="switch_default" class="toggleBtn"></label>
            </div>
            <form id="gridea-search-form" data-update="1648888087725" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
            </form>
        </div>
    </nav>

    
        <nav class="navbar-mobile" id="nav-mobile">
            <div class="container">
                <div class="navbar-header">
                    <div>
                        <a href="https://lesenelir.github.io">
                            Lesenelir&#39;s Blog
                        </a>
                        <!--en-->
                        <a id="mobile-toggle-theme-en" class="a en">&nbsp;Dark</a>
                        <!--zh-->
                        <a id="mobile-toggle-theme-zh" class="a zh">&nbsp;&#x6697;&#x9ED1;</a>
                    </div>
                    <form id="gridea-search-form" data-update="1648888087725" action="/search/index.html">
                        <input class="search-input" autocomplete="off" spellcheck="false" name="q" autofocus="true" placeholder="Search...">
                    </form>
                    <!--en-->
                    <div class="menu-toggle" id="menu-toggle-en" onclick="mobileBtn()">&#9776; Menu</div>
                    <!--zh-->
                    <div class="menu-toggle" id="menu-toggle-zh" onclick="mobileBtn()">&#9776; &#x83DC;&#x5355;</div>

                </div>
                <div class="menu" id="mobile-menu">
                    
                        <a class="menu-item" href="/">
                            Home
                        </a>
                        
                        <a class="menu-item" href="/post/about">
                            About
                        </a>
                        
                        <a class="menu-item" href="/archives">
                            Archives
                        </a>
                        
                        <a class="menu-item" href="/tags">
                            Tags
                        </a>
                        
                        <a class="menu-item" href="/post/timeline">
                            Timeline
                        </a>
                        
                        <a class="menu-item" href="https://github.com/lesenelir">
                            Github
                        </a>
                        
                </div>
            </div>
        </nav>
</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementById("menu-toggle-en");
        var toggleMenu_zh = document.getElementById("menu-toggle-zh");

        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.display != "none") {
            if (toggleMenu.classList.contains("active")) {
                toggleMenu.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu.classList.add("active")
                mobileMenu.classList.add("active")
            }
        } else if (toggleMenu_zh.display != "none") {
            if (toggleMenu_zh.classList.contains("active")) {
                toggleMenu_zh.classList.remove("active")
                mobileMenu.classList.remove("active")
            } else {
                toggleMenu_zh.classList.add("active")
                mobileMenu.classList.add("active")
            }
        }

    }
</script>

            <div class="main">
                <div class="container">
                    <article class="post-wrap">
                        <header class="post-header">
                            <h1 class="post-title">
                                JavaScript-Asynchronous
                            </h1>
                            
                                <!--en-->
                                <div class="post-meta en">
                                    Author:
                                    <a itemprop="author" rel="author" href="/">
                                        Lesenelir's Blog
                                    </a>
                                    <span class="post-time">
                                Date: <a href="#">2022-03-14</a>
                            </span>
                                    <span class="post-readtime">Reading Time:<a
                                    href="#">20.1
                                    mins</a></span>
                                    <span class="post-words">words:<a href="#">5105</a></span>
                                    
                                        <span class="post-category">
                                Category:
                                
                                <a href="https://lesenelir.github.io/tag/q4jSppOKl/">JavaScript</a>
                                
                            </span>
                                        
                                </div>
                                
                        </header>
                        
                        <div class="post-content">
                            <h3 id="一-异步操作概述">一、异步操作概述</h3>
<h4 id="11-单线程模式">1.1 单线程模式</h4>
<p>单线程模式让JavaScript可能不会出现“堵塞”问题</p>
<p><strong>事件循环机制Event Loop：</strong></p>
<ul>
<li>
<pre><code>  JS引擎一遍遍检查：只要同步任务执行完后，JS引擎就检查挂起来的异步任务能否进入主线程
</code></pre>
</li>
<li>
<pre><code>  这种循环检查机制，就叫事件循环
</code></pre>
</li>
<li>
<pre><code>  Promise回调函数是微任务，是一种特殊的异步任务；正常异步任务是在下一次事件循环执行，微任务是在本次事件循环执行
</code></pre>
</li>
</ul>
<hr>
<h4 id="12-同步任务和异步任务">1.2 同步任务和异步任务</h4>
<p>同步任务：</p>
<ul>
<li>没有被引擎挂起，在主线程排队执行的任务</li>
<li>只有前一个任务执行完毕，才能执行后一个任务</li>
</ul>
<p>异步任务：</p>
<ul>
<li>被引擎挂起，不进入主线程，进入任务队列的任务</li>
<li><strong>异步任务的写法都是采用回调函数方式</strong></li>
<li>异步任务不具有“堵塞”效应</li>
</ul>
<p>举例：</p>
<blockquote>
<p>Ajax 操作可以当作同步任务处理，也可以当作异步任务处理， 由开发者决定。</p>
<p>如果是同步任务，主线程就等着 Ajax 操作返回结果，再往下执行（会存在等待时延）。</p>
<p>如果是异步任务，主线程在发出 Ajax 请求后，就直接往下执行，等到 Ajax 操作有了结果，主线程再执行对应的<strong>回调函数（异步任务）</strong>。</p>
</blockquote>
<blockquote>
<p>Note:</p>
<ol>
<li>
<p>异步任务重新进入主线程是采用回调函数（函数作为参数）的方式</p>
</li>
<li>
<p>回调函数： 函数作为参数；定义了、执行了、但没调用</p>
</li>
</ol>
</blockquote>
<hr>
<h4 id="13-任务队列和事件循环">1.3 任务队列和事件循环</h4>
<p>JavaScript 运行时，除了一个正在运行的主线程，引擎还提供一个任务队列（task queue），里面是各种需要当前程序处理的异步任务。</p>
<p>JS运行流程：</p>
<p>主线程会去执行所有的同步任务。等到同步任务全部执行完，就会去看任务队列里面的异步任务。如果满足条件，那么异步任务通过回调函数的形式重新进入主线程开始执行，这时它就变成同步任务了。等到执行完，下一个异步任务再进入主线程开始执行。一旦任务队列清空，程序就结束执行。</p>
<ul>
<li>任务队列里存放异步任务</li>
<li>异步任务写法通常都是回调函数</li>
<li>一旦异步任务重新进入主线程，就会执行对应的回调函数</li>
<li>如果一个异步任务没有回调函数，就不会进入任务队列，即不会重新进入主线程（没有回调函数执行指定的操作）</li>
</ul>
<blockquote>
<p>通过编写回调函数的方式实现异步任务，一旦异步任务重新进入主线程，就执行回调函数</p>
</blockquote>
<hr>
<h4 id="14-异步操作的模式">1.4 异步操作的模式</h4>
<ul>
<li>回调函数</li>
<li>事件监听</li>
<li>发布/订阅</li>
</ul>
<hr>
<h4 id="15-异步操作的流程控制">1.5 异步操作的流程控制</h4>
<p>Problem： 多个异步操作，如何确定异步操作执行的顺序，以及如何保证遵守这种顺序</p>
<hr>
<h3 id="二-定时器">二、定时器</h3>
<p><code>setTimeout</code>函数用来指定某个函数或某段代码，在多少毫秒之后执行</p>
<p><code>setInterval</code>指定某个任务每隔一段时间就执行一次，也就是无限次的定时执行。</p>
<p><strong>定时器运行机制：</strong></p>
<p><code>setTimeout</code>和<code>setInterval</code>的运行机制，是<strong>将指定的代码移出本轮事件循环</strong>，等到下一轮事件循环，再检查是否到了指定时间。如果到了，就执行对应的代码；如果不到，就继续等待。</p>
<p><code>setTimeout</code>和<code>setInterval</code>指定的回调函数，必须等到本轮事件循环的所有同步任务都执行完，才会开始执行。</p>
<hr>
<h3 id="三-promise对象简单介绍">三、Promise对象简单介绍</h3>
<h4 id="31-概述">3.1 概述</h4>
<blockquote>
<p>Promise对象是Js的异步操作解决方案，为异步操作提供统一的接口。</p>
<p>充当异步操作与回调函数之间的中介，使得异步操作具备同步操作的接口</p>
</blockquote>
<p>Promise是一个对象，也是一个构造函数</p>
<blockquote>
<p>Promise设计思想：所有异步任务返回一个Promise实例，Promise实例有一个.then方法，用来指定下一步的回调函数</p>
</blockquote>
<pre><code class="language-javascript">function f1(resolve, reject) {
  // 异步代码...
}

var p1 = new Promise(f1);
p1.then(f2); // f1执行完才会去执行f2
// 传统写法把f2作为回调函数传入f1，比如写成f1(f2)
</code></pre>
<hr>
<h4 id="32-promise对象状态">3.2 Promise对象状态</h4>
<p>Promise实例有三种状态</p>
<ul>
<li>异步操作未完成 pending</li>
<li>执行异步操作后，异步操作成功 resolved，传回一个值value</li>
<li>执行异步操作后，异步操作失败 rejected，抛出一个错误error</li>
</ul>
<blockquote>
<p>一旦发生状态变化，就凝固，不会有新的状态变化。即，Promise实例状态变化只发生一次。</p>
</blockquote>
<hr>
<h4 id="33-promise构造函数">3.3 Promise构造函数</h4>
<pre><code class="language-javascript">var promise = new Promise(function (resolve, reject) {
  // ...

  if (/* 异步操作成功 */){
    resolve(value);
  } else { /* 异步操作失败 */
    reject(new Error());
  }
});
</code></pre>
<p>Promise构造函数接受一个函数作为参数（该函数称之为构造器函数），构造器函数的参数是resolve和reject，这两个也是函数，并由JavaScript引擎提供。</p>
<p><strong>resolve和reject本身都是一个函数</strong></p>
<blockquote>
<p>resolve，在异步操作成功时调用，将异步操作的结果，作为参数传递出去。</p>
<p>reject，在异步操作失败时调用，将异步操作抛出的错误，作为参数传递出去</p>
</blockquote>
<hr>
<h4 id="34-promiseprototypethen">3.4 Promise.prototype.then()</h4>
<p>Promise 实例的<code>then</code>方法，用来指定添加回调函数</p>
<blockquote>
<p>.then()可以接受两个回调函数参数：</p>
<ol>
<li>一个是异步操作成功的回调函数</li>
<li>一个是异步操作失败的回调函数</li>
</ol>
</blockquote>
<pre><code class="language-javascript">var p1 = new Promise(function (resolve, reject) {
  resolve('成功');
});
p1.then(console.log, console.error);
// &quot;成功&quot;

var p2 = new Promise(function (resolve, reject) {
  reject(new Error('失败'));
});
p2.then(console.log, console.error);
// Error: 失败
</code></pre>
<p><strong>.then()方法可以链式使用</strong></p>
<pre><code class="language-javascript"> p1
  .then(step1) // step都是回调函数
  .then(step2)
  .then(step3) // step3是函数有返回值，后一个then的log可以显示
  .then(
    console.log,
    console.error
  );
</code></pre>
<p>p1后面有四个then方法，即有四个回调函数，只要上一步为resolved就会依次执行后面的回调函数。</p>
<p>最后一个then方法，log只显示step3的返回值；<strong>error可以显示step1、step2、step3任意一个的错误</strong>。eg.如果<code>step1</code>的状态变为<code>rejected</code>，那么<code>step2</code>和<code>step3</code>都不会执行了。</p>
<blockquote>
<p>Promise对象的报错具有传递性</p>
</blockquote>
<p><strong>Note：简单来说：then()方法用来添加回调函数</strong></p>
<hr>
<h4 id="35-微任务">3.5 微任务</h4>
<p>Promise的回调函数不是正常的异步任务，而是微任务（microtask）</p>
<p>微任务和正常异步任务之间的区别：</p>
<ul>
<li>正常异步任务追加到下一轮事件循环</li>
<li>微任务（另外一种异步任务）追加到本轮事件循环</li>
<li>即：微任务的执行时间一定早于正常异步任务</li>
</ul>
<pre><code class="language-javascript">setTimeout(function() {
  console.log(1);
}, 0);

new Promise(function (resolve, reject) {
  resolve(2);
}).then(console.log);

console.log(3);
// 3
// 2
// 1
</code></pre>
<hr>
<h4 id="36-总结">3.6 总结</h4>
<p>Promise让回调函数变成了链式写法。可以同时执行多个异步操作，等它们状态都改变以后，再执行一个回调函数。</p>
<blockquote>
<p>Promise状态一旦改变，无论何时都可以看到这个状态。所以，可以随便什么时候都可以为Promise对象实例通过then方法添加回调函数，且都能执行。</p>
</blockquote>
<p><strong>即：Promise指定回调函数的方式更加灵活</strong></p>
<p>指定回调函数方式：</p>
<ul>
<li>纯回调函数方式
<ul>
<li>必须在异步任务之前指定回调函数（异步任务开始之前传入成功和失败的回调函数）</li>
</ul>
</li>
<li>Promise方式
<ul>
<li>可以在异步任务之前和之后指定回调函数（可以在请求发出甚至结束之后指定回调函数）</li>
<li>启动异步任务 =&gt; 返回Promise对象 =&gt; promise对象绑定回调函数(甚至<strong>可以在异步任务结束后指定</strong>）</li>
</ul>
</li>
</ul>
<hr>
<h3 id="四-promise对象总体介绍">四、Promise对象总体介绍</h3>
<h4 id="41-promise含义">4.1 Promise含义</h4>
<p>Promise是一种异步编程的解决方案，传统的异步编程解决方案是：回调函数和事件。</p>
<p>Promise是一个容器，里面保存一个异步操作的结果；Promise也是一个对象，从Promise可以获得异步操作的消息。</p>
<blockquote>
<p>Promise可以将异步操作以同步操作的流程表达出来，避免层层嵌套。</p>
</blockquote>
<p>Promise对象的特点：</p>
<ul>
<li>Promise对象状态只取决于异步操作的结果，不受外界影响。</li>
<li>Promise对象状态一旦改变，就不会再变化，且任何时候都可以得到这个结果；事件Event不同，一旦错过，再去监听也得不到结果。</li>
</ul>
<hr>
<h4 id="42-基本用法">4.2 基本用法</h4>
<pre><code class="language-javascript">const promise = new Promise(function(resolve, reject) {
  // ... some code
  
  if (/* 异步操作成功 */){
    resolve(value);
  } else {
    reject(error);
  }
});

promise.then(function(value) {
  // success
}, function(error) {
  // failure
});
</code></pre>
<p><strong>Promise实例对象生成后可以通过then()方法指定resolved状态和rejected状态的回调函数</strong></p>
<p>then()方法接受两个参数，且这两个参数都是回调函数形式，都接受Promise对象传出的值作为参数。</p>
<pre><code class="language-javascript">let promise = new Promise(function(resolve, reject) {
  console.log('Promise');
  resolve();
});

promise.then(function() {
  console.log('resolved.');
});

console.log('Hi!');

// Promise
// Hi!
// resolved
</code></pre>
<p>Promise新建后就会立即执行，即，Promise参数的执行器函数是一个同步回调，里面不是异步的代码都会立即执行。</p>
<pre><code class="language-javascript">const p1 = new Promise(function (resolve, reject) {
  // ...
});

const p2 = new Promise(function (resolve, reject) {
  // ...
  resolve(p1);
})
</code></pre>
<p>p2的resolve方法将p1作为参数，即p2异步操作的结果是返回p1的异步操作。</p>
<p>此时，p1的状态会传递给p2，即p1的状态决定了p2的状态。</p>
<blockquote>
<p>例子：</p>
</blockquote>
<pre><code class="language-javascript">const p1 = new Promise(function (resolve, reject) {
  setTimeout(() =&gt; reject(new Error('fail')), 3000)
})

const p2 = new Promise(function (resolve, reject) {
  setTimeout(() =&gt; resolve(p1), 1000)
})

p2
  .then(result =&gt; console.log(result))
  .catch(error =&gt; console.log(error))
// Error: fail
</code></pre>
<blockquote>
<p>p1三秒变为rejected状态，p2一秒后改变状态，resolve方法返回p1，此时p2自己状态无效，返回了另一个Promise对象的状态即p1状态。</p>
<p>此时针对p2的then方法，实质就是针对p1的then方法。</p>
</blockquote>
<p><strong>一般而言resolve()和rejected()方法都写在执行器函数的代码段最后，且在这两个函数之前加上return，保证执行器后面的代码不执行</strong></p>
<hr>
<h4 id="43-then方法">4.3 then()方法</h4>
<p>then()为Promise实例对象指定状态改变后的回调函数。</p>
<blockquote>
<p>重点：then()方法返回的是一个<strong>新的Promise实例</strong>（不是原来的Promise实例），所以then()可以采用链式写法，调用另一个then方法；同理，catch()方法返回的也是一个<strong>新的Promise实例</strong></p>
</blockquote>
<pre><code class="language-javascript">getJSON(&quot;/post/1.json&quot;)
.then(
  post =&gt; getJSON(post.commentURL) // getJSON返回一个新的Promise对象
).then(
  comments =&gt; console.log(&quot;resolved: &quot;, comments),
  err =&gt; console.log(&quot;rejected: &quot;, err)
);
</code></pre>
<p>该代码指定了两个回调函数，第一个then回调函数完成后，将返回结果作为参数，传入第二个then回调函数。第二个then回调函数，会等待新的Promise对象状态发生改变，如果状态变为resolved，就调用第一个回调函数，如果状态变为rejected，就调用第二个回调函数。</p>
<hr>
<h4 id="44-catch方法">4.4 catch()方法</h4>
<p>catch（）用来指定发生错误的回调函数，catch()返回的还是一个新的Promise对象</p>
<p><code>Promise.prototype.catch() === .then(null, reject) === .then(undefined, reject)</code></p>
<pre><code class="language-javascript">p.then((val) =&gt; console.log('fulfilled:', val))
  .catch((err) =&gt; console.log('rejected', err));

// 等同于
p.then((val) =&gt; console.log('fulfilled:', val))
  .then(null, (err) =&gt; console.log(&quot;rejected:&quot;, err));
</code></pre>
<p>捕获错误与抛出错误</p>
<pre><code class="language-javascript">// 写法一
const promise = new Promise(function(resolve, reject) {
  try {
    throw new Error('test');
  } catch(e) {
    reject(e);
  }
});
promise.catch(function(error) {
  console.log(error);
});

// 写法二
const promise = new Promise(function(resolve, reject) {
  reject(new Error('test'));
});
promise.catch(function(error) {
  console.log(error);
});
</code></pre>
<p><strong>Promise对象执行器函数中只能返回一个resolve或者reject，如果有两个，则返回第一个出现的函数（因为Promise状态一旦改变，就不会再变）</strong></p>
<pre><code class="language-javascript">const promise = new Promise(function(resolve, reject) {  resolve('ok');  throw new Error('test'); // 后一个不执行，promise状态改变就不发生变化});promise  .then(function(value) { console.log(value) })  .catch(function(error) { console.log(error) });// ok
</code></pre>
<p><strong>Promise对象的错误具有“冒泡性质”，会一直往后传递，直到被then处理err(reason)捕获为止</strong></p>
<blockquote>
<p>不建议写then的第二个参数即err(reson)参数；建议使用catch()方法，来捕获错误处理的回调函数</p>
</blockquote>
<hr>
<h4 id="45-finally方法">4.5 finally()方法</h4>
<p>finally()用来指定不管Promise对象最后状态如何，都会执行的操作。</p>
<pre><code class="language-javascript">promise.then(result =&gt; {···}).catch(error =&gt; {···}).finally(() =&gt; {···});server.listen(port)  .then(function () {    // ...  })  .finally(server.stop);
</code></pre>
<p>finally()方法不关心调用finally()的Promise实例状态，不依赖于Promise执行的结果。</p>
<hr>
<h4 id="46-all方法">4.6 all()方法</h4>
<p>all()将多个Promise实例，包装成一个新的Promise实例</p>
<pre><code class="language-javascript">const p = Promise.all([p1, p2, p3]);
</code></pre>
<p>特点：</p>
<ul>
<li>p1 p2 p3都为resolved，p的状态才是resolved。此时，p1 p2 p3 返回值组成一个数组，传递给p的回调函数。</li>
<li>p1 p2 p3有一个为rejected，p的状态就为rejected。此时，第一个被rejected的实例返回值，会传递给p的回调函数。</li>
</ul>
<pre><code class="language-javascript">const p1 = new Promise((resolve, reject) =&gt; {  resolve('hello');}).then(result =&gt; result).catch(e =&gt; e);const p2 = new Promise((resolve, reject) =&gt; {  throw new Error('报错了');}).then(result =&gt; result).catch(e =&gt; e);Promise.all([p1, p2]) // 此时p2执行上述代码的then方法.then(result =&gt; console.log(result)) // 调用这个回调函数.catch(e =&gt; console.log(e));// [&quot;hello&quot;, Error: 报错了]
</code></pre>
<p>上述代码解读：p1首先变为resolved，p2先变为rejected，但p2有自己的catch方法，该方法返回一个新的Promise实例对象，all函数中的p2Promise实例对象，其实是这个Promise实例对象。导致，all方法参数里的两个Promise实例对象都是resolved状态。</p>
<blockquote>
<p><strong>重点：如果一个promise中有reject()，但是其对应的回调函数then方法中有对应解决的reason，则该then返回新的Promise对象状态由回调函数执行结果return来决定</strong></p>
</blockquote>
<pre><code class="language-javascript">const p1 = new Promise((resolve, reject) =&gt; {  resolve('hello');}).then(result =&gt; result);const p2 = new Promise((resolve, reject) =&gt; {  throw new Error('报错了');}).then(result =&gt; result);Promise.all([p1, p2]).then(result =&gt; console.log(result)).catch(e =&gt; console.log(e));// Error: 报错了
</code></pre>
<p>上述代码解读：由于p2没有catch方法，就会调用all当中的catch方法</p>
<hr>
<h4 id="47-race方法">4.7 race()方法</h4>
<p>race() 英文有“比赛”意思。也是将多个Promise实例对象，包装成一个新的Promise实例对象，其中新的Promise实例对象状态和最先完成的子Promise实例对象有关。</p>
<pre><code class="language-javascript">const p = Promise.race([p1, p2, p3]);
</code></pre>
<p>其中，<code>p1</code>、<code>p2</code>、<code>p3</code>之中有一个实例率先改变状态，<code>p</code>的状态就跟着改变。那个率先改变的 Promise 实例的返回值，就传递给<code>p</code>的回调函数。</p>
<hr>
<h4 id="48-resolve方法">4.8 resolve()方法</h4>
<p>Promise.resolve()方法返回一个新的Promise实例对象，将现有对象转为Promise对象。</p>
<pre><code class="language-javascript">Promise.resolve('foo')// 等价于new Promise(resolve =&gt; resolve('foo'))
</code></pre>
<hr>
<h4 id="49-reject方法">4.9 reject()方法</h4>
<p>Promise.reject()方法返回一个新的Promise实例对象，该实例状态为rejected</p>
<pre><code class="language-javascript">const p = Promise.reject('出错了');// 等同于const p = new Promise((resolve, reject) =&gt; reject('出错了'))p.then(null, function (s) {  console.log(s)});// 出错了
</code></pre>
<hr>
<h4 id="410-promise关键点">4.10 Promise关键点</h4>
<ol>
<li>
<p>如何改变Promise对象的状态：</p>
<ul>
<li>resolve(value) 当前pending状态变为resolved状态</li>
<li>reject(reason) 当前pending状态变为rejected状态</li>
<li>throw new Error('xxx') 抛出异常，当前pending状态变为rejected状态</li>
</ul>
</li>
<li>
<p>一个Promise对象可以指定多个回调函数，并都会调用</p>
</li>
</ol>
<pre><code class="language-javascript">const p = new Promise((resolve, reject) =&gt; {  resolve(1)})p.then(    value =&gt; {      console.log('value1', value)    })p.then(    value =&gt; {      console.log('value2', value)    })// value1 1// value2 1
</code></pre>
<ol start="3">
<li>
<p>改变Promise状态和指定回调函数谁先谁后的问题</p>
<blockquote>
<p>指定回调函数指的是，调用then()方法</p>
</blockquote>
<ul>
<li>都有可能，正常情况下，是先指定回调函数，再改变Promise状态（纯回调函数先指定回调函数）；但也可以先Promise改变状态，再指定回调函数</li>
<li>如何先改变状态再指定回调函数？
<ul>
<li>在Promise的执行器函数中直接调用resolve() / reject()，执行器函数中没有异步代码</li>
<li>延长更长的时间才调用then()</li>
</ul>
</li>
<li>什么时候得到数据？
<ul>
<li>如果先指定回调，当状态改变时，回调函数就会调用，得到数据</li>
<li>如果先改变状态，当指定回调时，回调函数就会直接调用，得到数据</li>
</ul>
</li>
</ul>
<blockquote>
<p>如果执行器函数有异步回调，则先指定回调函数（then），后改变状态；</p>
<p>如果执行器函数中没有异步回调，则先改变状态，再通过then指定回调函数，并立即执行</p>
</blockquote>
</li>
<li>
<p>promise.then()返回的新promise实例对象的结果状态由什么决定？【重要】</p>
<ul>
<li>简单来说：由then指定回调函数执行的结果决定</li>
<li>复杂来说：
<ul>
<li>如果then()回调函数抛出异常，则新promise实例对象状态为rejected，reason为抛出异常</li>
<li>如果then()回调函数返回的是非promise对象的任意指，例如，return 3 / return undefined；则新Promise实例对象状态为resolved，value为回调函数返回值</li>
<li>如果then()回调函数返回的是一个新的Promise对象，则此Promise对象的结果为then回调函数后生成新的Promise对象的值 return Promise.resolve(3)</li>
</ul>
</li>
</ul>
<pre><code class="language-javascript">new Promise((resolve, reject) =&gt; {  reject(1)}).then(    value =&gt; {      console.log('onResolved1()', value)      // return 1    },    reason =&gt; {      console.log('onRejected1()', reason)      return Promise.resolve(2)      // return Promise.reject(2)    }).then(    value =&gt; {      console.log('onResolved2()', value)    },    reason =&gt; {      console.log('onRejected2()', reason)    })
</code></pre>
</li>
<li>
<p>Promise串联多个操作任务方法</p>
<ul>
<li>Promise的then方法返回一个新的Promise，可以当作then方法的链式调用</li>
<li>通过then链式调用串联多个同步 / 异步 任务</li>
</ul>
<pre><code class="language-javascript">new Promise((resolve, reject) =&gt; {  setTimeout(() =&gt; {    console.log(&quot;执行任务1(异步)&quot;)    resolve(1)  }, 1000);}).then(    value =&gt; {      console.log('任务1的结果: ', value)      console.log('执行任务2(同步)')      return 2    }).then(    value =&gt; {      console.log('任务2的结果:', value)      return new Promise((resolve, reject) =&gt; {        // 启动任务3(异步)        setTimeout(() =&gt; {          console.log('执行任务3(异步))')          resolve(3)        }, 1000);      })    }).then(    value =&gt; {      console.log('任务3的结果: ', value)    })
</code></pre>
</li>
<li>
<p>Promise的异常穿透</p>
<ul>
<li>
<p>当使用Promise的then链式调用，可以在最后指定失败的回调</p>
</li>
<li>
<p>链式操作，前面的操作出现了异常，都可以穿到最后失败的回调函数处</p>
</li>
<li>
<p><strong>Promise错误具有“冒泡性质”，会一直往后面传递，直至被then处理reason捕获为止</strong></p>
</li>
<li>
<blockquote>
<p>不建议写then的第二个参数即err(reson)参数；建议使用catch()方法，来捕获错误处理的回调函数</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>中断Promise链</p>
<ul>
<li>
<p>中断Promise链，意思是，在Promise的then链式调用中，在中间中断，不再调用后面的回调函数</p>
</li>
<li>
<p>方案：在某个then回调函数中返回一个pending状态的Promise对象</p>
<ul>
<li>
<pre><code class="language-javascript">return new Promise(() =&gt; {}) 
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr>
<h3 id="五-async和await使用">五、async和await使用</h3>
<h4 id="51-async">5.1 async</h4>
<p>async function用来定义一个异步函数（通过事件循环异步执行的函数）</p>
<p>async特点：</p>
<ul>
<li><strong>async函数的返回值是promise对象</strong>   return {promise}</li>
<li>async函数返回的promise对象结果值是由async函数执行的返回值决定</li>
</ul>
<pre><code class="language-javascript">async function fn1() {  return 1}const result1 = fn1()console.log(result1) // Promise { 1 }async function fn2() {  throw 2 // async返回一个失败的promise对象}const result2 = fn2()result2.catch(    reason =&gt; {      console.log(&quot;onRejected()&quot;, 2)    })// onRejected() 2
</code></pre>
<hr>
<h4 id="52-await">5.2 await</h4>
<p>await expression</p>
<p>expression表达式一般为promise对象，也可以是其他值</p>
<p>await特点：</p>
<ul>
<li>await 返回的是promise要处理的结果</li>
<li>如果表达式是promise对象，await返回的是【promise成功的值】</li>
<li>如果表达是其他值，直接将此值作为await的返回值</li>
</ul>
<p>await 作用：可以去掉then繁琐的操作</p>
<pre><code class="language-javascript">// 1. await得到成功的结果async function fn3() {  return Promise.resolve(3)}async function fn4() { // 使用await一定要用async函数  // const value = fn3()  // value.then(  //     value =&gt; {  //       console.log(value)  //     }  // )  const value = await fn3() // await 可以省去繁琐的then操作  console.log(value)}fn4()// 3// 2. await得到失败的结果async function fn5() {  return Promise.reject(4)}async function fn6() {  try {    const value = await fn5()    console.log(&quot;Value: &quot;, value)  } catch (e) {    console.log(&quot;Error: &quot;, e)  }}fn6()// Error:  4
</code></pre>
<hr>
<h3 id="六-宏队列和微队列">六、宏队列和微队列</h3>
<p>宏队列：</p>
<ul>
<li>用来保存待执行的宏任务(回调)， 比如: 定时器回调/DOM事件回调/ajax回调</li>
</ul>
<p>微队列：</p>
<ul>
<li>用来保存待执行的微任务(回调)， 比如: promise的回调/MutationObserver的回调</li>
</ul>
<p>JS引擎执行顺序：</p>
<ul>
<li>首先执行所有的同步任务代码</li>
<li>再执行微队列里的所有微任务</li>
<li>等微队列清空后，再去执行宏队列中的某个宏任务；如果某个宏任务里嵌套微任务，则把该微任务放入微队列，宏队列之后的宏任务要在该微任务之后执行。</li>
</ul>
<blockquote>
<p>关键点：执行宏队列中某个宏任务之前，需要清空微队列里的所有任务</p>
</blockquote>

                        </div>
                        
                                
                                    
                                        <!--en-->
                                        <section class="post-copyright en">
                                            <p class="copyright-item">
                                                <span>Author:</span>
                                                <span>Lesenelir's Blog</span>
                                            </p>

                                            <p class="copyright-item">
                                                <span>Permalink:</span>
                                                <span><a href="https://lesenelir.github.io/post/javascript-asynchronous/">https://lesenelir.github.io/post/javascript-asynchronous/</a></span>
                                            </p>

                                            <p class="copyright-item">
                                                <span>License:</span>
                                                <span>MIT License</span>
                                            </p>
                                        </section>
                                        
                                                
                                                    
                                                        <!-- Share-->
                                                        <span style="margin-right:15px">
                                                    <i class="post-share"></i>
                                                    <span>Share:</span>
                                                        <a title="QR Code" target="_blank" href="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://lesenelir.github.io/post/javascript-asynchronous/"><i class="fa fa-qrcode"></i></a>
                                                        <a title="QQ" target="_blank" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=https://lesenelir.github.io/post/javascript-asynchronous/&sharesource=qzone&title=JavaScript-Asynchronous&pics=https://lesenelir.github.io/images/avatar.png?v=1648888087725&summary="><i class="fa fa-qq"></i></a>
                                                        <a title="Weibo" target="_blank" href="https://service.weibo.com/share/share.php?url=https://lesenelir.github.io/post/javascript-asynchronous/&sharesource=weibo&title=JavaScript-Asynchronous + " - " + &pic="https://lesenelir.github.io/images/avatar.png?v=1648888087725 "><i class="fa fa-weibo "></i></a>
                                                        
                                                                </span>
                                                                <!--en-->
                                                                <section class="post-tags en ">
                                                                    <div>
                                                                        <span>Tag(s):</span>
                                                                        <span class="tag ">
                        
                        
                        <a href="https://lesenelir.github.io/tag/q4jSppOKl/">#
                                                JavaScript
                                                    </a>
                                                    
                                                        
                                                            </span>
                                                                    </div>
                                                                    <div>
                                                                        <a href="javascript:window.history.back();">back</a>
                                                                        <span>&dot;</span>
                                                                        <a href="#">home</a>
                                                                    </div>
                                                                </section>
                                                                
                                                                                <!---->
                                                                                <section class="post-nav">
                                                                                    
                                                                                            
                                                                                                <a class="next" rel="next" href="https://lesenelir.github.io/post/binary-search-tree/">
                                                                                                    Binary Search Tree 
                                                                                                </a>
                                                                                                
                                                                                </section>
                    </article>
                </div>
                
                                            
            </div>
    </div>
    </div>
    </div>
    
        <footer id="footer" class="footer">
            <div class="copyright">
                
                        <span id="sitetime"></span>
	<br />	
	<script>
		function siteTime(){
			window.setTimeout("siteTime()", 1000);
			var seconds = 1000;
			var minutes = seconds * 60;
			var hours = minutes * 60;
			var days = hours * 24;
			var years = days * 365;
			var today = new Date();
			var todayYear = today.getFullYear();
			var todayMonth = today.getMonth()+1;
			var todayDate = today.getDate();
			var todayHour = today.getHours();
			var todayMinute = today.getMinutes();
			var todaySecond = today.getSeconds();
			var t1 = Date.UTC(2019,06,28,00,00,00);  //此处填写建站时间 依次为 年,月,日,时,分,秒注意格式 半角,
			var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
			var diff = t2-t1;
			var diffYears = Math.floor(diff/years);
			var diffDays = Math.floor((diff/days)-diffYears*365);
			var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
			var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
			var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
			document.getElementById("sitetime").innerHTML="Lesenelir's blog has been running for "+diffYears+" year "+diffDays+" days "+diffHours+" hours "+diffMinutes+" minutes "+diffSeconds+" seconds";
		}
		siteTime();
	</script>
                            
                                        <svg viewBox="0 0 1024 1024" style="margin-left: 5px;margin-right: 5px;" version="1.0" width="8" height="8" class="my-face">
            <path
                d="M863.597631 513.574282l-271.33965-140.213484L729.783667 81.926656c3.583731-7.87141 7.167462-15.742819 7.167462-25.214109C736.887134 25.226908 708.345275 0.012799 672.635953 0.012799a63.611229 63.611229 0 0 0-39.293053 12.607055c-1.791866 1.59988-3.519736 3.19976-5.311602 3.19976L147.87531 418.925381a55.547834 55.547834 0 0 0-19.646527 47.356448c1.791866 17.278704 14.27093 33.021523 32.125591 42.492813l271.33965 141.749369L292.504463 945.221908c-12.479064 25.214109-1.791866 53.563983 23.166262 69.306802 10.751194 6.335525 23.230258 9.47129 35.709322 9.47129 16.062795 0 32.125591-4.735645 44.604655-15.742819l480.091993-403.297753a55.547834 55.547834 0 0 0 19.646526-47.228458 61.243407 61.243407 0 0 0-32.12559-44.156688z"
                fill="#93b5cf"></path>
        </svg>
                                        Lesenelir&#39;s Blog &copy;Copyright
                                            <script>
                                                var date = new Date();
                                                document.write("" + date.getFullYear());
                                            </script>
                                            | Powered by
                                            <a href="https://github.com" target="_blank">
                                                Github
                                            </a>
            </div>
            <div id="update" style="display:none;">
                on
            </div>
            
                <div id="version" style="display:none;">
                    1.7.5
                </div>
                
                    <script>
                        var port = '';
                        
                        document.write('<div id="home_path" style="display:none;">' + document.location.protocol + '//' + window.document.location.hostname + port + '</div>')
                    </script>
        </footer>
        
            <script src='https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js'></script>
            
                <script>
                    
                    
                    loadlive2d();
                    
                    
                    getStar();
                    hljs.initHighlighting();
                    console.clear();
                    
                    CheckVersion();
                    
                    var newDate = new Date();
                    newDate.setTime(1648888087725);
                    console.log(" Blog Update Time: " + newDate.toLocaleDateString());
                    console.log("\n %c \u26a1Theme:Chic Author's Blog:https://blog.itjoker.cn  Write By ITJoker  \n\n", "color: #ffffff; background: rgba(49, 49, 49, 0.85); padding:5px 0;border-radius:5px;");
                </script>
        </div>
</body>
<script>
    scroll();
</script>

</html>